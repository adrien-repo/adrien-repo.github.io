<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Interpreter</title>
     <link href="data:image/x-icon;base64,AAABAAEAEBACAAAAAACwAAAAFgAAACgAAAAQAAAAIAAAAAEAAQAAAAAAQAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAA////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYAAAAAAAAACQAAAAAAAAAAAAADwDwAA+B8AAPw/AADsNwAAzDMAAMQjAADkJwAA4AcAAPAPAAD4HwAA8A8AAPAPAADwDwAA8A8AAPAPAADwDwAA" rel="icon" type="image/x-icon" />

    <!-- Google Fonts for a digital feel (Matrix) and Linux feel -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Press+Start+2P&family=Ubuntu:wght@400;700&family=Ubuntu+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- CodeMirror for code editing -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <!-- Using a darker, more suitable CodeMirror theme like 'material-darker' or 'monokai' -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>

    <!-- Showdown for Markdown rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    
    <!-- Pyodide for Python execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>

    <style>
        /* Matrix Style Definitions (Default) */
        :root {
            --matrix-green: #00ff41; /* Bright green */
            --matrix-dark-green: #004d00; /* Darker green for accents */
            --matrix-black: #0a0a0a; /* Almost black */
            --matrix-grey: #1a1a1a; /* Dark grey for backgrounds */
            --matrix-light-grey: #2a2a2a; /* Slightly lighter grey */
            --matrix-error-red: #ff0000; /* Bright red for errors */

            /* Linux theme colors */
            --linux-bg: #2e3436;
            --linux-text: #d3d7cf;
            --linux-dark-border: #4e555b;
            --linux-cell-bg: #40454a;
            --linux-button-bg: #555b60;
            --linux-button-border: #5e6468;
            --linux-button-text: #eeeeec;
            --linux-primary-button-bg: #3465a4;
            --linux-primary-button-hover: #4682b4;
            --linux-codemirror-bg: #2b2b2b;
            --linux-error-red: #cc0000;
        }

        /* Base styles for Matrix mode (will be overridden by Linux mode) */
        body {
            font-family: 'Share Tech Mono', monospace; /* Digital monospace font */
            background-color: var(--matrix-black);
            color: var(--matrix-green);
            margin: 0;
            padding: 140px 20px 20px 20px;
            overflow-x: hidden; /* Prevent horizontal scroll due to potential overflow */
            position: relative; /* For pseudo-element background */
            text-shadow: 0 0 5px var(--matrix-dark-green); /* Subtle glow */
        }

        /* Digital Rain Effect (Subtle version) */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                to bottom,
                rgba(0, 255, 65, 0.02), /* Even more subtle green lines */
                rgba(0, 255, 65, 0.02) 2px,
                transparent 2px,
                transparent 40px
            );
            animation: digitalRain 30s linear infinite;
            z-index: -1; /* Behind content, but above matrix-rain-canvas */
            pointer-events: none; /* Do not interfere with clicks */
        }

        @keyframes digitalRain {
            from { background-position: 0 0; }
            to { background-position: 0 100%; }
        }

        /* Matrix Rain Canvas Styling */
        #matrix-rain-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; /* Furthest back */
            pointer-events: none;
            background-color: transparent; /* Ensure it's transparent to show body background */
            opacity: 0.5; /* Changed opacity for the canvas itself to 50% */
            transition: opacity 0.5s ease-in-out; /* Smooth transition for toggle */
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: var(--matrix-green);
            text-shadow: 0 0 8px var(--matrix-green);
        }
        
        #fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Semi-transparent black */
            z-index: 1000;
            padding: 10px 0;
            box-shadow: 0 0 15px var(--matrix-dark-green); /* Green glow shadow */
            border-bottom: 1px solid var(--matrix-dark-green);
        }
        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: rgba(10, 10, 10, 0.95); /* Increased opacity for main content background */
            padding: 20px 40px;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3); /* Green glow */
            border-radius: 8px;
            border: 1px solid var(--matrix-dark-green);
        }
        
        .notification-message {
            text-align: center;
            padding: 5px 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out, background-color 0.3s ease;
            color: var(--matrix-green);
            background-color: var(--matrix-light-grey);
            border: 1px solid var(--matrix-dark-green);
            text-shadow: none; /* Remove body text-shadow */
        }
        .notification-message.error {
            background-color: var(--matrix-error-red);
            color: white;
            border-color: #8b0000;
            text-shadow: 0 0 5px #ff4444;
        }
        .cell {
            border: 1px solid var(--matrix-dark-green);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 25px;
            background-color: var(--matrix-grey);
            transition: box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.15); /* Subtle cell glow */
        }
        .cell:hover {
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.5); /* Stronger glow on hover */
            transform: translateY(-2px);
        }
        .cell-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }
        button {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid var(--matrix-green);
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--matrix-dark-green); /* Dark green button */
            color: var(--matrix-green);
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 0 8px rgba(0, 255, 65, 0.4); /* Button glow */
            text-shadow: 0 0 3px var(--matrix-green);
        }
        button:hover {
            background-color: var(--matrix-green); /* Bright green on hover */
            color: var(--matrix-black);
            border-color: var(--matrix-green);
            transform: translateY(-1px);
            box-shadow: 0 0 15px var(--matrix-green); /* Stronger glow on hover */
            text-shadow: none;
        }
        button.primary {
            background-color: var(--matrix-green); /* Primary button is bright green */
            color: var(--matrix-black);
            border: none;
            box-shadow: 0 0 10px var(--matrix-green);
            text-shadow: none;
        }
        button.primary:hover {
            background-color: #00cc33; /* Slightly darker green on hover for primary */
            box-shadow: 0 0 20px var(--matrix-green);
        }
        .CodeMirror {
            border: 1px solid var(--matrix-dark-green);
            border-radius: 4px;
            height: auto;
            min-height: 100px;
            font-family: 'Share Tech Mono', monospace; /* Monospace font for code */
            font-size: 16px; /* Increased font size for visibility */
            line-height: 1.6; /* Increased line height for readability */
            background-color: var(--matrix-black); /* CodeMirror background */
            color: var(--matrix-green); /* Default text color */
            text-shadow: 0 0 3px var(--matrix-dark-green);
        }
        /* Override CodeMirror Dracula theme specific colors for Matrix feel */
        .CodeMirror-lines {
            color: var(--matrix-green);
        }
        .CodeMirror-gutters {
            background-color: var(--matrix-black) !important;
            border-right: 1px solid var(--matrix-dark-green) !important;
        }
        .CodeMirror-linenumber {
            color: var(--matrix-dark-green) !important;
        }
        .cm-keyword { color: #00cc33 !important; } /* Green keywords */
        .cm-atom { color: #00ff41 !important; } /* Green atoms */
        .cm-number { color: #00ff41 !important; } /* Green numbers */
        .cm-def { color: #00cc33 !important; } /* Green definitions */
        .cm-variable { color: var(--matrix-green) !important; }
        .cm-variable-2 { color: #009922 !important; }
        .cm-property { color: #00cc33 !important; }
        .cm-string { color: #00ff41 !important; } /* Bright green strings */
        .cm-string-2 { color: #00ff41 !important; }
        .cm-comment { color: #006600 !important; } /* Darker green comments */
        .cm-meta { color: #00cc33 !important; }
        .cm-qualifier { color: #00ff41 !important; }
        .cm-builtin { color: #00cc33 !important; }
        .cm-bracket { color: var(--matrix-green) !important; }
        .cm-tag { color: #00cc33 !important; }
        .cm-attribute { color: #00ff41 !important; }
        .cm-hr { color: #00ff41 !important; }
        .cm-link { color: #00ff41 !important; }
        .cm-error { color: var(--matrix-error-red) !important; }
        .cm-header { color: #00ff41 !important; }
        .cm-quote { color: #00ff41 !important; }
        .cm-negative { color: var(--matrix-error-red) !important; }
        .cm-positive { color: #00ff41 !important; }
        .cm-strong { font-weight: bold; color: #00ff41 !important; }
        .cm-em { font-style: italic; color: #00ff41 !important; }
        .cm-link { color: #00ff41 !important; text-decoration: underline; }
        .CodeMirror-cursor { border-left: 1px solid var(--matrix-green) !important; } /* Green cursor */
        .CodeMirror-activeline-background { background: rgba(0, 255, 65, 0.1) !important; } /* Subtle active line */


        .output-area {
            background-color: var(--matrix-black);
            color: var(--matrix-green);
            border-radius: 4px;
            padding: 10px;
            margin-top: 15px;
            border: 1px solid var(--matrix-dark-green);
            white-space: pre-wrap;
            font-family: 'Share Tech Mono', monospace;
            font-size: 15px; /* Increased font size for visibility */
            line-height: 1.6; /* Increased line height for readability */
            text-shadow: 0 0 3px var(--matrix-dark-green);
        }
        .output-area.error {
            color: var(--matrix-error-red); /* Red for errors */
            text-shadow: 0 0 5px #ff4444;
            border-color: #8b0000;
        }
        .markdown-preview {
            padding: 10px;
            color: var(--matrix-green);
            font-size: 16px; /* Increased font size for visibility */
            line-height: 1.6; /* Increased line height for readability */
            text-shadow: 0 0 3px var(--matrix-dark-green);
        }
        .markdown-preview h1, .markdown-preview h2, .markdown-preview h3 {
            border-bottom: 1px solid var(--matrix-dark-green);
            padding-bottom: 5px;
            color: var(--matrix-green);
            text-shadow: 0 0 8px var(--matrix-green);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95); /* Very dark overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            color: var(--matrix-green); /* Default to matrix green */
            z-index: 1000;
            text-shadow: 0 0 10px var(--matrix-green); /* Default to matrix glow */
        }
        .top-actions {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        /* Hidden file input */
        .hidden-file-input {
            display: none;
        }
        /* Margin for the cells container to push content below fixed header */
        #cells-container {
            margin-top: 40px;
        }

        /* Linux Mode Specific Styles */
        body[data-theme="linux"] {
            font-family: 'Ubuntu', sans-serif;
            background-color: var(--linux-bg); /* Darker background, Linux feel */
            color: var(--linux-text); /* Lighter text for dark background */
            text-shadow: none; /* Remove glow */
        }

        body[data-theme="linux"]::before {
            display: none; /* Hide digital rain lines */
        }

        body[data-theme="linux"] #matrix-rain-canvas {
            opacity: 0 !important; /* Ensure canvas is off */
        }

        body[data-theme="linux"] #fixed-header {
            background-color: var(--linux-bg); /* Match body background */
            box-shadow: none;
            border-bottom: 1px solid var(--linux-dark-border);
        }

        body[data-theme="linux"] .main-container {
            background-color: #343a40; /* Darker content area */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); /* Subtle shadow */
            border: 1px solid var(--linux-dark-border); /* Subtle border */
        }

        body[data-theme="linux"] .notification-message {
            background-color: #4a5255;
            border: 1px solid var(--linux-dark-border);
            color: var(--linux-button-text);
            text-shadow: none;
        }
        body[data-theme="linux"] .notification-message.error {
            background-color: var(--linux-error-red); /* Error red */
            color: white;
            border-color: var(--linux-error-red);
            text-shadow: none;
        }

        body[data-theme="linux"] .cell {
            border: 1px solid #4e554b;
            background-color: var(--linux-cell-bg);
            box-shadow: none;
        }
        body[data-theme="linux"] .cell:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        body[data-theme="linux"] button {
            border: 1px solid var(--linux-button-border);
            background-color: var(--linux-button-bg);
            color: var(--linux-button-text);
            box-shadow: none;
            text-shadow: none;
        }
        body[data-theme="linux"] button:hover {
            background-color: #60676d;
            border-color: #727a80;
            box-shadow: none;
        }
        button.primary {
            background-color: var(--linux-primary-button-bg); /* Linux-like blue */
            color: white;
            border: none;
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
        }
        button.primary:hover {
            background-color: var(--linux-primary-button-hover);
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }

        body[data-theme="linux"] .CodeMirror {
            border: 1px solid var(--linux-button-border);
            font-family: 'Ubuntu Mono', monospace;
            background-color: var(--linux-codemirror-bg);
            color: var(--linux-text); /* Lighter text for dark background */
            text-shadow: none;
        }
        body[data-theme="linux"] .CodeMirror-lines {
            color: var(--linux-text);
        }
        body[data-theme="linux"] .CodeMirror-gutters {
            background-color: var(--linux-codemirror-bg) !important;
            border-right: 1px solid var(--linux-button-border) !important;
        }
        body[data-theme="linux"] .CodeMirror-linenumber {
            color: #888 !important; /* Default CodeMirror line number color */
        }
        /* Revert CodeMirror syntax highlighting to a more standard theme for Linux mode */
        body[data-theme="linux"] .cm-keyword { color: #89ddff !important; } /* Example: light blue */
        body[data-theme="linux"] .cm-atom { color: #f08282 !important; } /* Example: light red */
        body[data-theme="linux"] .cm-number { color: #f08282 !important; }
        body[data-theme="linux"] .cm-def { color: #89ddff !important; }
        body[data-theme="linux"] .cm-variable { color: var(--linux-text) !important; }
        body[data-theme="linux"] .cm-variable-2 { color: #a9b7c6 !important; }
        body[data-theme="linux"] .cm-property { color: #89ddff !important; }
        body[data-theme="linux"] .cm-string { color: #a5d6a7 !important; } /* Example: light green */
        body[data-theme="linux"] .cm-string-2 { color: #a5d6a7 !important; }
        body[data-theme="linux"] .cm-comment { color: #616161 !important; } /* Dark grey comments */
        body[data-theme="linux"] .cm-meta { color: #89ddff !important; }
        body[data-theme="linux"] .cm-qualifier { color: #f08282 !important; }
        body[data-theme="linux"] .cm-builtin { color: #89ddff !important; }
        body[data-theme="linux"] .cm-bracket { color: var(--linux-text) !important; }
        body[data-theme="linux"] .cm-tag { color: #89ddff !important; }
        body[data-theme="linux"] .cm-attribute { color: #f08282 !important; }
        body[data-theme="linux"] .cm-hr { color: #f08282 !important; }
        body[data-theme="linux"] .cm-link { color: #89ddff !important; }
        body[data-theme="linux"] .CodeMirror-cursor { border-left: 1px solid var(--linux-text) !important; }
        body[data-theme="linux"] .CodeMirror-activeline-background { background: rgba(128, 128, 128, 0.1) !important; }
        /* Added for CodeMirror selection background in Linux mode */
        body[data-theme="linux"] .CodeMirror-selected {
            background-color: rgba(52, 101, 164, 0.5) !important; /* A darker, semi-transparent blue for selection */
        }


        body[data-theme="linux"] .output-area {
            background-color: var(--linux-codemirror-bg);
            color: var(--linux-button-text);
            border: 1px solid var(--linux-button-border);
            font-family: 'Ubuntu Mono', monospace;
            text-shadow: none;
        }
        body[data-theme="linux"] .output-area.error {
            color: #ef2929;
            text-shadow: none;
            border-color: #ef2929;
        }

        body[data-theme="linux"] .markdown-preview {
            color: var(--linux-text);
            text-shadow: none;
        }
        body[data-theme="linux"] .markdown-preview h1,
        body[data-theme="linux"] .markdown-preview h2,
        body[data-theme="linux"] .markdown-preview h3 {
            border-bottom: 1px solid var(--linux-button-border);
            color: var(--linux-button-text);
            text-shadow: none;
        }

        /* Styles for the modal popup */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dark semi-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Above everything else */
            display: none; /* Hidden by default */
        }

        .modal-content {
            background-color: var(--matrix-grey);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.5); /* Matrix glow */
            border: 1px solid var(--matrix-green);
            max-width: 500px;
            width: 90%;
            position: relative;
            color: var(--matrix-green);
            font-family: 'Share Tech Mono', monospace;
            text-shadow: 0 0 5px var(--matrix-dark-green);
        }
        body[data-theme="linux"] .modal-content {
            background-color: var(--linux-cell-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--linux-dark-border);
            color: var(--linux-text);
            font-family: 'Ubuntu', sans-serif;
            text-shadow: none;
        }

        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--matrix-green);
            line-height: 1;
            padding: 5px;
            transition: color 0.2s ease;
        }
        .modal-close-button:hover {
            color: #ff0000; /* Red on hover */
        }
        body[data-theme="linux"] .modal-close-button {
            color: var(--linux-text);
        }
        body[data-theme="linux"] .modal-close-button:hover {
            color: #ef2929;
        }


        .package-selection-header {
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
            color: var(--matrix-green);
            text-shadow: 0 0 8px var(--matrix-green);
        }
        body[data-theme="linux"] .package-selection-header {
            color: var(--linux-text);
            text-shadow: none;
        }

        .package-selection-list {
            width: 100%;
            height: 200px; /* Fixed height for scrollability */
            overflow-y: auto; /* Enable scrolling */
            border: 1px solid var(--matrix-dark-green);
            border-radius: 4px;
            margin-bottom: 15px;
            background-color: var(--matrix-black);
            color: var(--matrix-green);
            padding: 5px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        body[data-theme="linux"] .package-selection-list {
            border: 1px solid var(--linux-dark-border);
            background-color: var(--linux-codemirror-bg);
            color: var(--linux-text);
            font-family: 'Ubuntu Mono', monospace;
        }

        .package-item {
            padding: 5px 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .package-item.selected {
            background-color: var(--matrix-dark-green);
            color: white;
        }
        .package-item.loaded {
            color: #888; /* Dim loaded packages */
            cursor: default;
        }
        .package-item:not(.loaded):hover {
            background-color: rgba(0, 255, 65, 0.1); /* Subtle hover for Matrix */
        }
        body[data-theme="linux"] .package-item.selected {
            background-color: var(--linux-primary-button-bg);
            color: white;
        }
        body[data-theme="linux"] .package-item.loaded {
            color: #888;
        }
        body[data-theme="linux"] .package-item:not(.loaded):hover {
            background-color: rgba(52, 101, 164, 0.2); /* Subtle hover for Linux */
        }

        .package-status {
            font-size: 0.8em;
            font-style: italic;
            color: #00cc33; /* Green for loaded status */
        }
        body[data-theme="linux"] .package-status {
            color: #a5d6a7; /* Lighter green for Linux loaded status */
        }

        .package-install-button {
            display: block;
            width: 100%;
            padding: 10px;
            font-size: 16px;
            margin-top: 15px;
        }
        /* Linux mode specific styles for loading overlay */
        body[data-theme="linux"] .loading-overlay {
            color: var(--linux-text);
            text-shadow: none;
        }
    </style>
</head>
<body data-theme="linux"> <!-- Changed default theme to linux -->

<canvas id="matrix-rain-canvas"></canvas>

<div class="loading-overlay" id="loading-overlay">
    Loading Python interpreter...
</div>

<!-- Fixed Header Area -->
<div id="fixed-header">
    <h5 id="notification-message" class="notification-message"></h5>
    <div class="top-actions">
        <button onclick="addCell('code')">Add Code Cell</button>
        <button onclick="addCell('markdown')">Add Markdown Cell</button>
        <button onclick="document.getElementById('importPyInput').click()">Import .py</button>
        <button onclick="document.getElementById('importIpynbInput').click()">Import .ipynb</button>
        <button onclick="exportToipynb()">Export .ipynb</button>
        <button onclick="exportToPy()">Export .py</button>
        <button class="primary" onclick="runAllCells()">Run All</button>
        <button id="toggleModeButton" onclick="toggleMatrixMode()">Matrix Mode: Off</button> <!-- Changed initial button text -->
        <button onclick="openPackageModal()">Manage Packages</button>
    </div>
</div>

<div class="main-container" id="notebook-container" style="display: none;">
    <!-- Hidden file inputs for import functionality -->
    <input type="file" id="importPyInput" class="hidden-file-input" accept=".py" onchange="importPyFile(event)">
    <input type="file" id="importIpynbInput" class="hidden-file-input" accept=".ipynb" onchange="importIpynbFile(event)">

    <div id="cells-container"></div>
</div>

<!-- Package Selection Modal -->
<div id="package-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-button" onclick="closePackageModal()">&times;</button>
        <h2 class="package-selection-header">Manage Python Packages</h2>
        <div id="package-list" class="package-selection-list">
            <!-- Package items will be populated here by JS -->
        </div>
        <button class="primary package-install-button" onclick="installSelectedPackages()">Install Selected Packages</button>
    </div>
</div>

<script>
    let pyodide;
    let notebookCells = [];
    let cmInstances = {}; // Store CodeMirror instances by cell ID
    const markdownConverter = new showdown.Converter();
    let notificationTimeout; // To manage notification hiding
    let matrixRainInterval; // To store the interval ID for matrix rain
    let loadedPackages = new Set(); // To keep track of loaded packages
    let selectedPackagesInModal = new Set(); // To keep track of selected packages in the modal

    // List of pre-built Pyodide packages (can be expanded)
    const availablePackages = [
        'micropip',
        'numpy',
        'pandas',
        'packaging',
        'python-dateutil',
        'pytz',
        'six',
        'scipy',
        'matplotlib',
        'scikit-learn',
        'sympy',
        'requests',
        'Pillow',
        'statsmodels',
        'networkx',
        'beautifulsoup4',
        'lxml',
        'plotly',
        'bokeh',
        'altair',
        'seaborn',
        'numexpr',
        'openpyxl',
        'xlrd',
        'xlsxwriter',
        'pyyaml',
        'toml',
        'fastjsonschema',
        'pygments',
        'markdown',
        'ipywidgets',
        'tqdm'
    ];


    // Matrix Rain Canvas Logic
    const canvas = document.getElementById('matrix-rain-canvas');
    const ctx = canvas.getContext('2d');

    let W = window.innerWidth;
    let H = window.innerHeight;
    canvas.width = W;
    canvas.height = H;

    const characters = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz!@#$%^&*()_+{}[]|:;"<>,.?/~`';
    const font_size = 15; // Smaller font size for rain
    const columns = Math.floor(W / font_size);
    const drops = []; // Array to store y-position of each drop

    for (let i = 0; i < columns; i++) {
        drops[i] = 1; // Start drops at the top
    }

    function drawMatrixRain() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        ctx.fillRect(0, 0, W, H);

        ctx.fillStyle = '#00ff41'; // Matrix green color
        ctx.font = `${font_size}px 'Share Tech Mono'`;

        for (let i = 0; i < drops.length; i++) {
            const text = characters.charAt(Math.floor(Math.random() * characters.length));
            ctx.fillText(text, i * font_size, drops[i] * font_size);

            // Send the drop back to the top randomly
            if (drops[i] * font_size > H && Math.random() > 0.975) {
                drops[i] = 0;
            }

            // Increment y-position
            drops[i]++;
        }
    }

    // Function to toggle Matrix Mode (themes and wallpaper)
    function toggleMatrixMode() {
        const body = document.body;
        const toggleButton = document.getElementById('toggleModeButton');
        const canvas = document.getElementById('matrix-rain-canvas');

        if (body.dataset.theme === 'matrix') {
            // Switch to Linux Mode
            body.dataset.theme = 'linux';
            canvas.style.opacity = '0'; // Turn off Matrix rain canvas
            clearInterval(matrixRainInterval); // Stop animation
            matrixRainInterval = null; // Clear the interval ID
            toggleButton.textContent = 'Matrix Mode: Off';
            showNotification('Switched to Linux Mode.');
            // Revert CodeMirror theme for Linux mode
            for (const id in cmInstances) {
                if (cmInstances.hasOwnProperty(id)) {
                    cmInstances[id].setOption('theme', 'default'); // CodeMirror default theme (or another light/dark Linux-friendly one)
                }
            }
        } else {
            // Switch to Matrix Mode
            body.dataset.theme = 'matrix';
            canvas.style.opacity = '0.5'; // Turn on Matrix rain canvas with 50% opacity
            if (!matrixRainInterval) { // Only start if not already running
                matrixRainInterval = setInterval(drawMatrixRain, 33); // Restart animation
            }
            toggleButton.textContent = 'Matrix Mode: On';
            showNotification('Switched to Matrix Mode.');
            // Set CodeMirror theme back to material-darker for Matrix mode
            for (const id in cmInstances) {
                if (cmInstances.hasOwnProperty(id)) {
                    cmInstances[id].setOption('theme', 'material-darker');
                }
            }
        }
    }

    // Adjust canvas size on window resize
    window.addEventListener('resize', () => {
        W = window.innerWidth;
        H = window.innerHeight;
        canvas.width = W;
        canvas.height = H;
        // Reinitialize drops for new column count
        const newColumns = Math.floor(W / font_size);
        drops.length = 0; // Clear existing drops
        for (let i = 0; i < newColumns; i++) {
            drops[i] = Math.floor(Math.random() * H / font_size); // Random start position
        }
    });

    // Function to show a temporary notification message
    function showNotification(message, isError = false) {
        const notificationElement = document.getElementById('notification-message');
        clearTimeout(notificationTimeout); // Clear any existing timeout

        notificationElement.textContent = message;
        notificationElement.classList.remove('error');
        if (isError) {
            notificationElement.classList.add('error');
        }
        notificationElement.style.opacity = '1'; // Make visible
        notificationElement.style.pointerEvents = 'auto'; // Make interactive if needed (though not for simple text)


        notificationTimeout = setTimeout(() => {
            notificationElement.style.opacity = '0'; // Start fade out
            notificationElement.style.pointerEvents = 'none'; // Make non-interactive after fade
            // No need to set display: 'none' as min-height keeps space
        }, 4000); // Display for 4 seconds
    }

    // Function to refresh all CodeMirror instances
    function refreshAllCodeMirrors() {
        for (const id in cmInstances) {
            if (cmInstances.hasOwnProperty(id)) {
                cmInstances[id].refresh();
            }
        }
    }

    // Function to populate the package selection list in the modal
    async function populatePackageList() {
        if (!pyodide) {
            showNotification("Python interpreter not loaded yet. Cannot retrieve package list.", true);
            return;
        }

        const packageListDiv = document.getElementById('package-list');
        packageListDiv.innerHTML = ''; // Clear existing items
        selectedPackagesInModal.clear(); // Clear previous selections

        const allAvailablePackages = availablePackages;

        // Sort available packages alphabetically, but keep loaded ones at the top if desired
        const sortedPackages = [...allAvailablePackages].sort((a, b) => {
            const aLoaded = loadedPackages.has(a);
            const bLoaded = loadedPackages.has(b);
            if (aLoaded && !bLoaded) return -1;
            if (!aLoaded && bLoaded) return 1;
            return a.localeCompare(b);
        });

        sortedPackages.forEach(pkg => {
            const packageItem = document.createElement('div');
            packageItem.classList.add('package-item');
            packageItem.dataset.packageName = pkg;

            const packageNameSpan = document.createElement('span');
            packageNameSpan.textContent = pkg;
            packageItem.appendChild(packageNameSpan);

            const statusSpan = document.createElement('span');
            statusSpan.classList.add('package-status');

            if (loadedPackages.has(pkg)) {
                statusSpan.textContent = '[Loaded]';
                packageItem.classList.add('loaded');
                packageItem.style.cursor = 'default'; // Indicate it's not selectable
            } else {
                packageItem.onclick = () => {
                    if (selectedPackagesInModal.has(pkg)) {
                        selectedPackagesInModal.delete(pkg);
                        packageItem.classList.remove('selected');
                    } else {
                        selectedPackagesInModal.add(pkg);
                        packageItem.classList.add('selected');
                    }
                };
            }
            packageItem.appendChild(statusSpan);
            packageListDiv.appendChild(packageItem);
        });
    }

    // Function to install selected packages from the modal
    async function installSelectedPackages() {
        if (!pyodide) {
            showNotification("Python interpreter not loaded yet. Please wait.", true);
            return;
        }

        const packagesToInstall = Array.from(selectedPackagesInModal);

        if (packagesToInstall.length === 0) {
            showNotification("No packages selected to install.", true);
            return;
        }

        showNotification(`Installing ${packagesToInstall.join(', ')}... This may take a moment.`);
        try {
            await pyodide.loadPackage(packagesToInstall);
            packagesToInstall.forEach(pkg => loadedPackages.add(pkg)); // Add to loaded set
            showNotification(`Successfully installed: ${packagesToInstall.join(', ')}`);
            populatePackageList(); // Refresh the modal list to show new status
            selectedPackagesInModal.clear(); // Clear selections after installation
        } catch (error) {
            console.error("Failed to install packages:", error);
            showNotification(`Failed to install packages: ${error.message || error}`, true);
        }
    }

    // Functions to open and close the package modal
    function openPackageModal() {
        populatePackageList(); // Always refresh list when opening
        document.getElementById('package-modal').style.display = 'flex';
    }

    function closePackageModal() {
        document.getElementById('package-modal').style.display = 'none';
    }


    async function loadPyodideAndLibs() {
        const loadingOverlay = document.getElementById('loading-overlay');
        const notebookContainer = document.getElementById('notebook-container');
        const canvas = document.getElementById('matrix-rain-canvas'); // Get canvas here too

        try {
            console.log('Starting Pyodide loading process...');
            loadingOverlay.innerText = 'Initializing...';
            // Apply Linux styles to loading overlay immediately
            loadingOverlay.style.color = 'var(--linux-text)';
            loadingOverlay.style.textShadow = 'none';
            
            pyodide = await loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.1/full/",
            });
            console.log('Pyodide core loaded.');

            // Changed loading text as requested
            loadingOverlay.innerText = 'Loading essential Python packages...';
            // Load essential packages at startup, including packaging, python-dateutil, pytz, six
            const essentialPackages = ['micropip', 'numpy', 'pandas', 'packaging', 'python-dateutil', 'pytz', 'six'];
            await pyodide.loadPackage(essentialPackages);
            essentialPackages.forEach(pkg => loadedPackages.add(pkg)); // Add essential packages to loaded set
            console.log('Essential packages loaded.');
            
            loadingOverlay.style.display = 'none';
            notebookContainer.style.display = 'block';
            console.log('Pyodide and packages ready. Notebook displayed.');
            showNotification('Python interpreter loaded successfully!');

            // Add initial cells with imports for all loaded packages and warning suppression
            addCell('code', `import warnings
warnings.filterwarnings('ignore', category=DeprecationWarning) # Suppress deprecation warnings

import micropip # For installing Python packages
import numpy as np # For numerical operations
import packaging # For Python packaging utilities
import pandas as pd # For data manipulation and analysis
import dateutil # For datetime operations
import pytz # For timezone handling
import six # For Python 2 and 3 compatibility

print(f"Preloaded with: micropip {micropip.__version__}, numpy {np.__version__}, packaging {packaging.__version__}, pandas {pd.__version__}, dateutil {dateutil.__version__}, pytz {pytz.__version__}, six {six.__version__}")
print("Hello, World!")

`);
            
            // Crucial: Refresh CodeMirror instances after the container is visible
            refreshAllCodeMirrors();

            // Set initial state for Linux Mode after everything is loaded
            document.body.dataset.theme = 'linux';
            canvas.style.opacity = '0'; // Ensure canvas is off
            document.getElementById('toggleModeButton').textContent = 'Matrix Mode: Off';
            // Set CodeMirror theme for Linux mode for any pre-existing cells
            for (const id in cmInstances) {
                if (cmInstances.hasOwnProperty(id)) {
                    cmInstances[id].setOption('theme', 'default');
                }
            }


        } catch (error) {
            console.error("Pyodide loading failed:", error);
            loadingOverlay.style.color = '#d9534f';
            loadingOverlay.innerText = `Failed to load Pyodide. Please check your internet connection and browser console for details. Error: ${error.message || error}`;
            showNotification(`Failed to load Python interpreter: ${error.message || error}`, true);
        }
    }

    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }

    function renderNotebook() {
        const cellsContainer = document.getElementById('cells-container');
        cellsContainer.innerHTML = '';
        // Before clearing cmInstances, clean up old CodeMirror editors to prevent memory leaks
        for (const id in cmInstances) {
            if (cmInstances.hasOwnProperty(id) && cmInstances[id].toTextArea) {
                cmInstances[id].toTextArea(); // Detach CodeMirror from textarea
            }
        }
        cmInstances = {}; // Clear previous CodeMirror instances, as we're rebuilding the DOM
        
        notebookCells.forEach((cell, index) => {
            const cellDiv = document.createElement('div');
            cellDiv.classList.add('cell');
            cellDiv.dataset.id = cell.id; // Store cell ID in data attribute

            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('cell-actions');
            
            const upButton = document.createElement('button');
            upButton.textContent = '▲';
            upButton.onclick = () => moveCell(index, -1);
            upButton.disabled = (index === 0); // Disable if first cell
            actionsDiv.appendChild(upButton);

            const downButton = document.createElement('button');
            downButton.textContent = '▼';
            downButton.onclick = () => moveCell(index, 1);
            downButton.disabled = (index === notebookCells.length - 1); // Disable if last cell
            actionsDiv.appendChild(downButton);

            const removeButton = document.createElement('button');
            removeButton.textContent = 'Remove';
            removeButton.onclick = () => removeCell(cell.id);
            actionsDiv.appendChild(removeButton);

            if (cell.type === 'code') {
                const runButton = document.createElement('button');
                runButton.classList.add('primary');
                runButton.textContent = '▶ Run';
                actionsDiv.appendChild(runButton);

                const clearOutputButton = document.createElement('button');
                clearOutputButton.textContent = 'Clear Output';
                clearOutputButton.onclick = () => clearCellOutput(cell.id);
                actionsDiv.appendChild(clearOutputButton);

                const textarea = document.createElement('textarea');
                textarea.value = cell.content;
                cellDiv.appendChild(actionsDiv);
                cellDiv.appendChild(textarea);
                
                // Synchronous CodeMirror initialization
                const editor = CodeMirror.fromTextArea(textarea, {
                    mode: 'python',
                    theme: document.body.dataset.theme === 'matrix' ? 'material-darker' : 'default', /* Dynamic theme */
                    lineNumbers: true,
                    indentUnit: 4,
                    extraKeys: {
                        "Shift-Enter": () => runCell(editor, cell.id)
                    }
                });
                
                // Update cell.content when CodeMirror editor changes
                editor.on('change', (instance) => {
                    cell.content = instance.getValue();
                });

                runButton.onclick = () => runCell(editor, cell.id);
                cmInstances[cell.id] = editor; // Store for runAllCells direct access

                const outputDiv = document.createElement('pre');
                outputDiv.classList.add('output-area');
                outputDiv.textContent = cell.output || '';
                if (cell.error) {
                    outputDiv.classList.add('error');
                } else {
                    outputDiv.classList.remove('error');
                }
                cellDiv.appendChild(outputDiv);

            } else if (cell.type === 'markdown') {
                const toggleButton = document.createElement('button');
                toggleButton.textContent = cell.isEditing ? 'Preview' : 'Edit';
                toggleButton.onclick = () => toggleMarkdownMode(cell.id);
                actionsDiv.appendChild(toggleButton);
                
                cellDiv.appendChild(actionsDiv);
                
                if (cell.isEditing) {
                    const textarea = document.createElement('textarea');
                    textarea.value = cell.content;
                    textarea.rows = Math.max(5, cell.content.split('\n').length + 1); // Adjust rows dynamically
                    textarea.style.width = '100%';
                    textarea.style.boxSizing = 'border-box';
                    textarea.oninput = (e) => {
                        cell.content = e.target.value;
                        e.target.rows = Math.max(5, e.target.value.split('\n').length + 1); // Adjust rows dynamically
                    };
                    cellDiv.appendChild(textarea);
                } else {
                    const previewDiv = document.createElement('div');
                    previewDiv.classList.add('markdown-preview');
                    previewDiv.innerHTML = markdownConverter.makeHtml(cell.content);
                    cellDiv.appendChild(previewDiv);
                }
            }
            cellsContainer.appendChild(cellDiv);
        });
        // Crucial: Refresh CodeMirror instances after rendering is complete
        refreshAllCodeMirrors();
    }

    async function runCell(editorInstance, cellId) {
        const cell = notebookCells.find(c => c.id === cellId);
        if (!cell || !pyodide) {
            console.error("Pyodide not loaded or cell not found.");
            showNotification("Python interpreter not ready. Please wait.", true);
            return;
        }

        cell.output = '...Running...';
        cell.error = null;
        // Update only the specific cell's output area to show "Running..."
        const currentCellDiv = document.querySelector(`[data-id="${cellId}"]`);
        if (currentCellDiv) {
            const outputArea = currentCellDiv.querySelector('.output-area');
            if (outputArea) {
                outputArea.textContent = cell.output;
                outputArea.classList.remove('error');
            }
        }

        const code = editorInstance.getValue(); // Get the latest code from the editor
        
        try {
            // Make the JavaScript 'code' variable directly available as a Python string variable
            pyodide.globals.set('user_code_string', code);

            const captured = await pyodide.runPythonAsync(`
import io, sys
from contextlib import redirect_stdout, redirect_stderr

output = io.StringIO()
error = io.StringIO()

with redirect_stdout(output), redirect_stderr(error):
    try:
        # Execute the Python string stored in 'user_code_string'
        # 'globals()' ensures it runs in the current Python namespace, preserving state.
        exec(user_code_string, globals())
    except Exception:
        import traceback
        traceback.print_exc()

(output.getvalue(), error.getvalue())
`);
            
            const [stdout, stderr] = captured.toJs();
            
            if (stderr) {
                cell.output = stderr;
                cell.error = true;
                showNotification("Code execution failed. Check output for details.", true);
            } else {
                cell.output = stdout;
                cell.error = false;
                showNotification("Cell executed successfully!", false);
            }

        } catch (err) {
            cell.output = `An unexpected Pyodide error during execution:\n${err.message}`;
            cell.error = true;
            console.error("Pyodide execution error:", err);
            showNotification(`Pyodide execution error: ${err.message}`, true);
        } finally {
            // Clean up the temporary global variable in Python
            pyodide.globals.delete('user_code_string');
        }

        // Re-render only the specific cell's output area with final result
        if (currentCellDiv) {
            const outputArea = currentCellDiv.querySelector('.output-area');
            if (outputArea) {
                outputArea.textContent = cell.output;
                if (cell.error) {
                    outputArea.classList.add('error');
                } else {
                    outputArea.classList.remove('error');
                }
            }
        }
    }

    // Function to run all code cells sequentially
    async function runAllCells() {
        if (!pyodide) {
            showNotification("Python interpreter not loaded yet. Please wait.", true);
            return;
        }

        showNotification("Running all code cells...");
        
        // Clear all outputs in data model and then update DOM
        notebookCells.forEach(cell => {
            if (cell.type === 'code') {
                cell.output = '';
                cell.error = false;
            }
        });
        // Manually clear outputs in the DOM to avoid full re-render
        document.querySelectorAll('.output-area').forEach(outputArea => {
            outputArea.textContent = '';
            outputArea.classList.remove('error');
        });


        for (const cell of notebookCells) {
            if (cell.type === 'code') {
                const editorInstance = cmInstances[cell.id];
                if (editorInstance) {
                    await runCell(editorInstance, cell.id);
                    // If an error occurred in a cell, stop further execution
                    if (cell.error) {
                        console.warn(`Execution stopped at cell ${cell.id} due to an error.`);
                        showNotification(`Execution stopped at cell with error.`, true);
                        break; 
                    }
                } else {
                    console.warn(`CodeMirror instance not found for cell ${cell.id}. This indicates a rendering issue.`);
                    showNotification(`Skipping cell ${cell.id}: editor not ready.`, true);
                    // Do not break here, try to run other cells if possible, but log the warning.
                }
            }
        }
        showNotification("All code cells executed!");
    }


    function addCell(type, content = '', index) {
        const newCell = {
            id: generateId(),
            type: type,
            content: content,
            output: '',
            isEditing: type === 'markdown'
        };
        if (index === undefined) {
            notebookCells.push(newCell);
        } else {
            notebookCells.splice(index + 1, 0, newCell);
        }
        renderNotebook();
        // Scroll to the newly added cell
        const newCellElement = document.querySelector(`[data-id="${newCell.id}"]`);
        if (newCellElement) {
            newCellElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        showNotification(`Added new ${type} cell.`);
    }

    function removeCell(cellId) {
        notebookCells = notebookCells.filter(cell => cell.id !== cellId);
        // Also remove the CodeMirror instance from our map and clean up
        if (cmInstances[cellId]) {
            cmInstances[cellId].toTextArea(); // Detach CodeMirror from textarea
            delete cmInstances[cellId];
        }
        renderNotebook();
        showNotification("Cell removed.");
    }

    function moveCell(fromIndex, direction) {
        const toIndex = fromIndex + direction;
        if (toIndex >= 0 && toIndex < notebookCells.length) {
            const [movedCell] = notebookCells.splice(fromIndex, 1);
            notebookCells.splice(toIndex, 0, movedCell);
            renderNotebook();
            // Scroll to the moved cell
            const movedCellElement = document.querySelector(`[data-id="${movedCell.id}"]`);
            if (movedCellElement) {
                movedCellElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            showNotification("Cell moved.");
        }
    }

    function clearCellOutput(cellId) {
        const cell = notebookCells.find(c => c.id === cellId);
        if (cell && cell.type === 'code') {
            cell.output = '';
            cell.error = false;
            // Only update the specific cell's output area in the DOM
            const currentCellDiv = document.querySelector(`[data-id="${cellId}"]`);
            if (currentCellDiv) {
                const outputArea = currentCellDiv.querySelector('.output-area');
                if (outputArea) {
                    outputArea.textContent = '';
                    outputArea.classList.remove('error');
                }
            }
            showNotification("Output cleared.");
        }
    }

    function toggleMarkdownMode(cellId) {
        const cell = notebookCells.find(c => c.id === cellId);
        if (cell) {
            cell.isEditing = !cell.isEditing;
            renderNotebook();
            showNotification(`Markdown cell switched to ${cell.isEditing ? 'edit' : 'preview'} mode.`);
        }
    }

    function exportToipynb() {
        const ipynbData = {
            "cells": notebookCells.map(cell => {
                const cellObject = {
                    "cell_type": cell.type,
                    "source": cell.content.split('\n'),
                    "metadata": {},
                };
                if (cell.type === "code" && cell.output) {
                    const outputType = cell.error ? "error" : "stream";
                    const outputName = cell.error ? "stderr" : "stdout";
                    cellObject.outputs = [{
                        "output_type": outputType,
                        "name": outputName,
                        "text": cell.output.split('\n')
                    }];
                }
                return cellObject;
            }),
            "metadata": {
                "kernelspec": { "display_name": "Python 3", "language": "python", "name": "python3" },
                "language_info": { "codemirror_mode": { "name": "ipython", "version": 3 }, "name": "python", "version": "3.10.4" }
            },
            "nbformat": 4,
            "nbformat_minor": 5
        };
        const blob = new Blob([JSON.stringify(ipynbData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'notebook.ipynb';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showNotification("Notebook exported as .ipynb");
    }

    function exportToPy() {
        let pyContent = '';
        notebookCells.forEach(cell => {
            if (cell.type === 'code') {
                pyContent += cell.content + '\n\n';
            } else if (cell.type === 'markdown') {
                pyContent += cell.content.split('\n').map(line => `# ${line}`).join('\n') + '\n\n';
            }
        });
        const blob = new Blob([pyContent], { type: 'text/x-python' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'notebook.py';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showNotification("Notebook exported as .py");
    }

    // --- Import Functions ---

    function importPyFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const content = e.target.result;
            notebookCells = []; // Clear current notebook before importing .py
            renderNotebook(); // Re-render to show empty notebook
            addCell('code', content);
            showNotification("Python file imported successfully!");
        };
        reader.onerror = (e) => {
            console.error("Error reading .py file:", e);
            showNotification("Failed to read .py file.", true);
        };
        reader.readAsText(file);
        event.target.value = ''; // Clear the input so same file can be selected again
    }

    function importIpynbFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const jsonContent = JSON.parse(e.target.result);
                if (jsonContent.cells && Array.isArray(jsonContent.cells)) {
                    notebookCells = []; // Clear current notebook before importing
                    jsonContent.cells.forEach(importedCell => {
                        // CRUCIAL FIX: Join source array with '\n' to preserve newlines
                        const cellContent = Array.isArray(importedCell.source) ? importedCell.source.join('\n') : importedCell.source;
                        let cellOutput = '';
                        let cellError = false;

                        // Extract output if present
                        if (importedCell.outputs && importedCell.outputs.length > 0) {
                            importedCell.outputs.forEach(output => {
                                if (output.output_type === 'stream' && output.name === 'stdout' && output.text) {
                                    cellOutput += output.text.join('');
                                } else if (output.output_type === 'error' && output.name === 'stderr' && output.traceback) {
                                    // For errors, traceback is usually in 'traceback' field
                                    cellOutput += output.traceback.join('');
                                    cellError = true;
                                }
                                // Handle other output types like 'execute_result' if needed
                                else if (output.output_type === 'execute_result' && output.data && output.data['text/plain']) {
                                    cellOutput += output.data['text/plain'].join('');
                                }
                            });
                        }

                        if (importedCell.cell_type === 'code' || importedCell.cell_type === 'markdown') {
                            const newCell = {
                                id: generateId(),
                                type: importedCell.cell_type,
                                content: cellContent,
                                output: cellOutput,
                                error: cellError,
                                isEditing: importedCell.cell_type === 'markdown' // Default to editing for markdown on import
                            };
                            notebookCells.push(newCell);
                        }
                    });
                    renderNotebook();
                    showNotification("Notebook imported successfully!");
                } else {
                    showNotification("Invalid .ipynb file format: 'cells' array not found.", true);
                }
            } catch (jsonError) {
                console.error("Error parsing .ipynb file:", jsonError);
                showNotification("Failed to parse .ipynb file. It might be corrupted or not a valid JSON.", true);
            }
        };
        reader.onerror = (e) => {
            console.error("Error reading .ipynb file:", e);
            showNotification("Failed to read .ipynb file.", true);
        };
        reader.readAsText(file);
        event.target.value = ''; // Clear the input so same file can be selected again
    }


    document.addEventListener('DOMContentLoaded', () => {
        loadPyodideAndLibs(); // Then load Pyodide and essential libs
    });
</script>
</body>
</html>
