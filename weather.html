<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Weather</title>
    <style>
        body {font-family: Roboto, sans-serif;}
	.feed {align-items: center;margin: 10px; border: 0.1em solid #d9d9d9;border-radius: 0.5em}
	@media only screen and (min-width: 720px) {  .feed {    width: 700px; }}
	@media only screen and (min-width: 320px) and (max-width: 699px) {  .feed {    width: 95vw;  }}
	@media only screen and (max-width: 319px) {  .feed {    width: 95vw;  }}
	.container {display: flex; flex-wrap: wrap; gap: 10px; }	
	canvas {width: 100%;height: 50%;max-width: 700px;max-height: 400px;}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
</head>
<body>
    <center>
		<div class="feed">
			<h3>Weather in <span id="locationName"></span></h3>
			<div class="container">
				<canvas id="weatherChart"></canvas>
				<canvas id="windUvChart"></canvas>
			<br>
			</div>
		</div>
	</center>

	<script>
		async function fetchWeatherData() {
			return new Promise((resolve, reject) => {
				navigator.geolocation.getCurrentPosition(async (position) => {
					const { latitude, longitude } = position.coords;
					const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&hourly=temperature_2m,precipitation,windspeed_10m,uv_index`);
					const data = await response.json();
					const locationResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&addressdetails=1`);
					const locationData = await locationResponse.json();
					const locationName = locationData.address.city || locationData.address.town || locationData.address.village || 'Your Location';
					document.getElementById('locationName').innerText = locationName;
					resolve(data.hourly);
				}, reject);
			});
		}

		function createAnnotations(labels, chartHeight) {
			const annotations = [];
			const currentDateTime = new Date();
			let lastDate = null;

			labels.forEach(label => {
				const date = label.getDate();
				if (lastDate !== null && date !== lastDate) {
					annotations.push({
						type: 'line',
						mode: 'vertical',
						scaleID: 'x',
						value: label,
						borderColor: 'rgba(150, 166, 255, 0.95)',
						borderWidth: 1
					});
				}
				lastDate = date;
			});

			const dynamicYAdjust = -chartHeight / 2 - 0; 

			annotations.push({
				type: 'line',
				mode: 'vertical',
				scaleID: 'x',
				value: currentDateTime,
				borderColor: 'rgba(50, 81, 252, 0.8)',
				borderWidth: 1,
				label: {
					enabled: true,
					content: 'Now',
					position: 'center',
					backgroundColor: 'rgba(50, 81, 252, 0.95)',
					yAdjust: dynamicYAdjust,
					font: {
						size: 10 
					}
				}
			});

			return annotations;
		}

		function createTemperaturePrecipitationChart(ctx, labels, temperatureData, precipitationData) {
			const chart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [
						{
							type: 'line',
							label: 'Temperature (°C)',
							color: 'black',
							data: temperatureData,
							borderColor: 'black',
							backgroundColor: 'black',
							borderWidth: 1,
							pointRadius: 0,  
							yAxisID: 'y1',
							fill: false
						},
						{
							type: 'bar',
							label: 'Precipitation (mm)',
							color: 'black',
							data: precipitationData,
							backgroundColor: 'rgba(54, 162, 235, 0.6)',
							yAxisID: 'y2'
						}
					]
				},
				options: {
					responsive: true,
					scales: {
						x: {
							type: 'time',
							time: {
								displayFormats: {
									hour: "MMM d, HH'h'"
								}
							},
							grid: {
								display: false 
							}
						},
						y1: {
							type: 'linear',
							position: 'left',
							beginAtZero: true,
							title: {
								display: true,
								text: 'Temperature (°C)',
								color: 'black'
							}
						},
						y2: {
							type: 'linear',
							position: 'right',
							beginAtZero: true,
							title: {
								display: true,
								text: 'Precipitation (mm)',
								color: 'black'
							},
							grid: {
								drawOnChartArea: false
							}
						}
					},
					plugins: {
						title: {
							display: true, 
							text: 'Temperature (line), Precipitations (bars)',
							color: 'black'
						},
						legend: {
							display: false 
						},
						annotation: {
							annotations: []
						}
					}
				},
				plugins: [{
					id: 'dynamicAnnotation',
					afterDraw: (chart) => {
						const chartHeight = chart.chartArea.bottom - chart.chartArea.top;
						chart.options.plugins.annotation.annotations = createAnnotations(labels, chartHeight);
						chart.update();
					}
				}]
			});
		}

		function createWindUvChart(ctx, labels, windSpeedData, uvIndexData) {
			const chart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: labels,
					datasets: [
						{
							label: 'Wind Speed (10 m) (km/h)',
							color: 'black',
							data: windSpeedData,
							borderColor: 'green',
							backgroundColor: 'green',
							pointRadius: 0,  
							borderWidth: 1,
							yAxisID: 'y1',
							fill: false
						},
						{
							label: 'UV Index',
							color: 'black',
							data: uvIndexData,
							borderColor: 'orange',
							backgroundColor: 'orange',
							pointRadius: 0,  
							borderWidth: 1,
							yAxisID: 'y2',
							fill: false
						}
					]
				},
				options: {
					responsive: true,
					scales: {
						x: {
							type: 'time',
							time: {
								displayFormats: {
									hour: "MMM d, HH'h'"
								}
							},
							grid: {
								display: false 
							}
						},
						y1: {
							type: 'linear',
							position: 'left',
							beginAtZero: true,
							title: {
								display: true,
								text: 'Wind Speed (km/h)',
								color: 'black'
							}
						},
						y2: {
							type: 'linear',
							position: 'right',
							beginAtZero: true,
							title: {
								display: true,
								text: 'UV Index',
								color: 'black'
							},
							grid: {
								drawOnChartArea: false
							}
						}
					},
					plugins: {
						title: {
							display: true, 
							text: 'Wind Speed (green), UV Index (yellow)',
							color: 'black'
						},
						legend: {
							display: false 
						},
						annotation: {
							annotations: []
						}
					}
				},
				plugins: [{
					id: 'dynamicAnnotation',
					afterDraw: (chart) => {
						const chartHeight = chart.chartArea.bottom - chart.chartArea.top;
						chart.options.plugins.annotation.annotations = createAnnotations(labels, chartHeight);
						chart.update();
					}
				}]
			});
		}

		async function renderCharts() {
			const hourlyData = await fetchWeatherData();

			const labels = hourlyData.time.map(time => new Date(time));
			const temperatureData = hourlyData.temperature_2m;
			const precipitationData = hourlyData.precipitation;
			const windSpeedData = hourlyData.windspeed_10m;
			const uvIndexData = hourlyData.uv_index;

			const ctx1 = document.getElementById('weatherChart').getContext('2d');
			const ctx2 = document.getElementById('windUvChart').getContext('2d');

			createTemperaturePrecipitationChart(ctx1, labels, temperatureData, precipitationData);
			createWindUvChart(ctx2, labels, windSpeedData, uvIndexData);
		}

		renderCharts();
	</script>

</body>
</html>
